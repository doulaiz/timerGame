<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Timer Game</title>
   <style>
      :root {
         --main-bg: #222;
         --flash-bg: #ffba3b;
         --timeout-bg: #fd5151;
         --bar-color: #4caf50;
         --modal-bg: #666;
         --modal-shadow: 0 2px 16px #0006;
         --accent: #4caf50;
         --text: #fff;
         --ripple: rgba(122, 238, 122, 0.5);
      }

      body {
         margin: 0;
         min-height: 100vh;
         background: var(--main-bg);
         transition: background 0.2s;
         font-family: system-ui, sans-serif;
      }

      .flash {
         animation: flash-bg 0.2s alternate 3;
      }

      @keyframes flash-bg {
         from {
            background: var(--main-bg);
         }

         to {
            background: var(--flash-bg);
         }
      }

      .timeout {
         background: var(--timeout-bg) !important;
      }

      .center-message {
         position: absolute;
         top: 50%;
         left: 50%;
         transform: translate(-50%, -50%);
         color: var(--text);
         font-size: 4rem !important;
         text-align: center;
         user-select: none;
         z-index: 10;
      }

      #timerBar {
         position: fixed;
         left: 0;
         bottom: 0;
         width: 8px;
         height: 0;
         background: var(--bar-color);
         z-index: 5;
         transition: height 1s linear;
         border-radius: 3px;
         opacity: 0.5;
      }

      .ripple {
         position: absolute;
         border-radius: 50%;
         transform: scale(0);
         animation: ripple-anim 0.6s linear;
         background: var(--ripple);
         pointer-events: none;
         z-index: 9999;
      }

      @keyframes ripple-anim {
         to {
            transform: scale(2);
            opacity: 0;
         }
      }

      .myBtn {
         position: fixed;
         z-index: 10000;
         border: none;
         background: none;
         color: var(--text);
         cursor: pointer;
         font-size: 1.1rem;
      }

      #settingsBtn {
         top: 20px;
         right: 20px;
         padding: 8px 14px;
      }


      #modalOverlay {
         display: none;
         position: fixed;
         top: 0;
         left: 0;
         width: 100vw;
         height: 100vh;
         background: rgba(0, 0, 0, 0.5);
         z-index: 10001;
         align-items: center;
         justify-content: center;
      }

      #modalTitle {
         color: #fff;
      }

      .modal {
         background: var(--modal-bg);
         padding: 32px 24px;
         border-radius: 12px;
         box-shadow: var(--modal-shadow);
         min-width: 260px;
         max-width: 90vw;
         text-align: center;
         position: relative;
         margin-top: -40vh;
      }

      #closeModal {
         position: absolute;
         top: 10px;
         right: 10px;
         background: none;
         border: none;
         color: var(--text);
         font-size: 1.3rem;
         cursor: pointer;
      }

      #durationInput {
         width: 80px;
         font-size: 1.2rem;
         padding: 4px 8px;
         border-radius: 4px;
         border: 1px solid #888;
         margin-bottom: 10px;
      }

      #saveDuration {
         padding: 6px 18px;
         border: none;
         border-radius: 6px;
         background: var(--accent);
         color: var(--text);
         font-size: 1.1rem;
         cursor: pointer;
      }
   </style>

   <script src="NoSleep.min.js"></script>
   <link rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
</head>

<body onload="on_load()">
   <div id="timerBar"></div>
   <button id="settingsBtn" class="myBtn" aria-label="Open settings menu">
      <span class="material-symbols-outlined">
         settings
      </span>
   </button>
   <div class="center-message material-symbols-outlined" id="message">
      timer
   </div>
   <button id="restartBtn" class="myBtn"
      style="display:none;position:absolute;top:90%;left:50%;transform:translate(-50%,0);">
      <span class="material-symbols-outlined">
         replay
      </span>
   </button>

   <div id="modalOverlay">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
         <button id="closeModal" aria-label="Close settings">✖</button>
         <h2 id="modalTitle">Timer Duration</h2>
         <input id="durationInput" type="number" min="5" max="60" value="20" />

         <span style="color:#fff;font-size:1.1rem;">seconds</span>
         <br><br>
         <button id="saveDuration">Save</button>
      </div>
   </div>
   <script>
      // --- Timer Game Logic ---
      let timer = null;
      let timerDuration = parseInt(localStorage.getItem('timerDuration')) || 20;
      let timeLeft = timerDuration;
      let flashing = false;
      let flashThreshold = Math.min(timerDuration / 3, 5);
      const message = document.getElementById('message');
      const body = document.body;
      const settingsBtn = document.getElementById('settingsBtn');
      const timerBar = document.getElementById('timerBar');
      const modalOverlay = document.getElementById('modalOverlay');
      const closeModal = document.getElementById('closeModal');
      const durationInput = document.getElementById('durationInput');
      const saveDuration = document.getElementById('saveDuration');
      const restartBtn = document.getElementById('restartBtn');
      if (timerDuration) {
         document.getElementById('durationInput').value = timerDuration;
      }
      function updateTitle() {
         if (timeLeft > 0) {
            document.title = `⏳ ${timeLeft}`;
         } else {
            document.title = '⏰';
         }
      }

      function updateTimerBar() {
         if (timeLeft > 0 && timeLeft <= timerDuration) {
            const percent = (timeLeft - 1) / (timerDuration - 1);
            timerBar.style.height = (percent * 100) + 'vh';
            timerBar.style.opacity = '1';
         } else {
            timerBar.style.height = '0';
            timerBar.style.opacity = '0.5';
         }
      }

      function resetTimer() {
         if (timer) clearInterval(timer);
         timeLeft = timerDuration;
         body.classList.remove('timeout', 'flash');
         message.textContent = '';
         timerBar.style.transition = 'none';
         setTimeout(() => {
            timerBar.style.transition = 'height 1s linear';
         }, 20);
         updateTitle();
         updateTimerBar();
         startTimer();
      }

      function startTimer() {
         updateTitle();
         updateTimerBar();
         timer = setInterval(() => {
            timeLeft--;
            updateTitle();
            updateTimerBar();
            if (timeLeft <= flashThreshold && timeLeft > 0 && !flashing) {
               flashing = true;
               body.classList.add('flash');
               setTimeout(() => {
                  body.classList.remove('flash');
                  flashing = false;
               }, 600);
            }
            if (timeLeft <= 0) {
               clearInterval(timer);
               body.classList.add('timeout');
               message.textContent = '';
               updateTitle();
               updateTimerBar();
               // Play end sound
               const audio = new Audio('sound/end.mp3');
               audio.play();
               console.log('Time is up!');
               setTimeout(() => {
                  restartBtn.style.display = 'block';
                  restartBtn.style.opacity = '0';
                  restartBtn.style.transition = 'opacity 0.6s';
                  setTimeout(() => {
                     restartBtn.style.opacity = '1';
                  }, 10);
               }, 2000);
               message.textContent = "sentiment_very_dissatisfied";
            }
         }, 1000);
      }

      body.addEventListener('click', (e) => {
         // if modal open, ignore clicks
         if (modalOverlay.style.display === 'flex') return;
         // If timeout, ignore screen clicks (only restartBtn works)
         let timeoutActive = (timeLeft <= 0);
         // Ripple effect
         const rippleColor = timeoutActive ? 'rgba(128,0,255,0.5)' : 'rgba(122, 238, 122, 0.5)';
         const ripple = document.createElement('span');
         ripple.className = 'ripple';
         ripple.style.background = rippleColor;
         const size = Math.max(window.innerWidth, window.innerHeight);
         ripple.style.width = ripple.style.height = size + 'px';
         ripple.style.left = (e.clientX - size / 2) + 'px';
         ripple.style.top = (e.clientY - size / 2) + 'px';
         ripple.style.position = 'fixed';
         document.body.appendChild(ripple);
         ripple.addEventListener('animationend', () => ripple.remove());

         if (!timeoutActive) {
            const clickAudio = new Audio('sound/click.mp3');
            clickAudio.play();
         }
         if (timeoutActive) return;
         resetTimer();
      });

      if (restartBtn) {
         restartBtn.addEventListener('click', () => {
            restartBtn.style.opacity = '0';
            restartBtn.style.transform = 'scale(8) translate(-6.25%, -50%)';
            restartBtn.style.transition = 'transform 2s linear, opacity 2s';

            setTimeout(() => {
               restartBtn.style.display = 'none';
               restartBtn.style.opacity = '1';
               restartBtn.style.transform = 'scale(1) translate(-50%, 0)';
            }, 2500);

            resetTimer();
         });
      }

      // Modal logic
      settingsBtn.addEventListener('click', (e) => {
         e.stopPropagation();
         durationInput.value = timerDuration;
         modalOverlay.style.display = 'flex';
         durationInput.focus();
      });
      closeModal.addEventListener('click', (e) => {
         e.stopPropagation();
         modalOverlay.style.display = 'none';
      });
      modalOverlay.addEventListener('click', (e) => {
         if (e.target === modalOverlay) modalOverlay.style.display = 'none';
      });
      saveDuration.addEventListener('click', (e) => {
         e.stopPropagation();
         let val = parseInt(durationInput.value, 10);
         if (isNaN(val) || val < 5) val = 5;
         if (val > 600) val = 600;
         timerDuration = val;
         localStorage.setItem('timerDuration', timerDuration);
         modalOverlay.style.display = 'none';
         flashThreshold = Math.min(timerDuration / 3, 5);
         resetTimer();
      });

      // Keyboard accessibility for modal
      durationInput.addEventListener('keydown', (e) => {
         if (e.key === 'Enter') {
            saveDuration.click();
         }
      });
      // Set initial title
      document.title = 'Timer Game';

      function on_load() {
         var noSleep = new NoSleep();
         noSleep.enable(); // keep the screen on!
      }
   </script>
</body>

</html>